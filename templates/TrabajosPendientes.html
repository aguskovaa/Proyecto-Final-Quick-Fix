<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trabajos Pendientes - QuickFix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='TrabajosPendientes.css') }}">
</head>
<body>
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
        <div class="line line-4"></div>
    </div>

    <!-- Modal de cancelaci√≥n -->
    <div class="modal-overlay" id="modalCancelacion">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Cancelar Trabajo</h3>
                <button class="close-modal" onclick="cerrarModalCancelacion()">&times;</button>
            </div>
            <form id="formCancelacion">
                <input type="hidden" id="trabajoIdCancelacion" value="">
                <div class="form-group">
                    <label for="motivoCancelacion">Motivo de cancelaci√≥n:</label>
                    <textarea id="motivoCancelacion" placeholder="Explica brevemente por qu√© cancelas este trabajo..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="cerrarModalCancelacion()">Volver</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">Confirmar Cancelaci√≥n</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-container">
                <div class="logo">Quick<span>Fix</span></div>
                <a href="{{ url_for('home') }}" class="back-button"><i class="fas fa-arrow-left"></i> Volver al Inicio</a>
            </div>
            <nav class="nav">
                <a href="{{ url_for('home') }}" class="nav-item">Inicio</a>
                <a href="/trabajos" class="nav-item">Solicitudes</a>
                <a href="/trabajos_pendientes" class="nav-item active">Trabajos Pendientes</a>
                <a href="#" class="nav-item">Historial</a>
                <a class="nav-item" href="{{ url_for('logout') }}"><i class="fas fa-user"></i> Cerrar Sesi√≥n</a>
            </nav>
        </header>

                <main class="main-content">
            <div class="page-header">
                <h1>Trabajos Pendientes</h1>
                <p>Gestiona tus contrataciones de clientes y mentor√≠as activas.</p>
            </div>

            <!-- SECCI√ìN CONTRATACIONES DE CLIENTES -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Contrataciones de Clientes</h2>
                    <span class="contador-badge">{{ trabajos_contrataciones|length }} pendientes</span>
                </div>
                
                {% if trabajos_contrataciones %}
                <div class="trabajos-grid">
                    {% for trabajo in trabajos_contrataciones %}
<div class="trabajo-card" data-tipo="contratacion">
    <!-- AGREGAR BADGE ESPECIAL PARA TRABAJOS DEL MURO -->
    {% if trabajo.get('origen') == 'muro' %}
    <div class="tipo-badge tipo-muro">üì∞ Del Muro</div>
    {% else %}
    <div class="tipo-badge tipo-contratacion">üí∞ Contrataci√≥n</div>
    {% endif %}
    
    <div class="trabajo-header">
        <h3>{{ trabajo.especializacion or trabajo.titulo or trabajo.categoria }}</h3>
        <span class="estado-badge estado-pendiente">Aceptado</span>
    </div>

    <div class="trabajo-info">
        <div class="info-group">
            <h4>Informaci√≥n del Cliente</h4>
            <div class="info-item">
                <span class="info-label">Cliente:</span>
                <span class="info-value">{{ trabajo.cliente_nombre }}</span>
            </div>
            <!-- MOSTRAR ORIGEN -->
            <div class="info-item">
                <span class="info-label">Origen:</span>
                <span class="info-value">
                    {% if trabajo.get('origen') == 'muro' %}
                    üì∞ Publicaci√≥n del Muro
                    {% else %}
                    üîç B√∫squeda Directa
                    {% endif %}
                </span>
            </div>
        </div>

        <div class="info-group">
            <h4>Detalles del Trabajo</h4>
            <div class="info-item">
                <span class="info-label">Fecha acordada:</span>
                <span class="info-value">{{ trabajo.fecha_trabajo_propuesta or trabajo.fecha_limite or 'Por acordar' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Ubicaci√≥n:</span>
                <span class="info-value">{{ trabajo.ubicacion }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">M√©todo de pago:</span>
                <span class="info-value">{{ trabajo.metodo_pago or 'Por acordar' }}</span>
            </div>
            {% if trabajo.presupuesto %}
            <div class="info-item">
                <span class="info-label">Presupuesto:</span>
                <span class="info-value">${{ trabajo.presupuesto }}</span>
            </div>
            {% endif %}
        </div>

        <div class="info-group">
            <h4>Descripci√≥n del Trabajo</h4>
            <p class="especificaciones">{{ trabajo.especificaciones or trabajo.descripcion }}</p>
        </div>
    </div>

    <!-- Botones de acci√≥n (se mantienen igual) -->
    <div class="trabajo-actions">
        <button class="btn btn-complete" onclick="finalizarTrabajo('{{ trabajo.id }}', 'contratacion')">
            <i class="fas fa-check-circle"></i> Finalizado
        </button>
        <button class="btn btn-contact" onclick="contactarCliente('{{ trabajo.cliente_id }}')">
            <i class="fas fa-envelope"></i> Contactar Cliente
        </button>
        <button class="btn btn-cancel-job" onclick="abrirModalCancelacion('{{ trabajo.id }}', 'contratacion')">
            <i class="fas fa-times-circle"></i> Cancelar Trabajo
        </button>
    </div>
</div>
{% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No tienes contrataciones pendientes</h3>
                    <p>Cuando aceptes trabajos de clientes, aparecer√°n aqu√≠.</p>
                </div>
                {% endif %}
            </div>

            <!-- SECCI√ìN MENTOR√çAS -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Mentor√≠as Activas</h2>
                    <span class="contador-badge">{{ trabajos_mentorias|length }} activas</span>
                </div>
                
                {% if trabajos_mentorias %}
                <div class="trabajos-grid">
                    {% for mentoria in trabajos_mentorias %}
                    <div class="trabajo-card" data-tipo="mentoria">
                        
                        <div class="trabajo-header">
                            <h3>Mentor√≠a - {{ mentoria.area_interes }}</h3>
                            <span class="estado-badge estado-mentoria">En Progreso</span>
                        </div>

                        <div class="trabajo-info">
                            <div class="info-group">
                                <h4>Informaci√≥n del Aprendiz</h4>
                                <div class="info-item">
                                    <span class="info-label">Aprendiz:</span>
                                    <span class="info-value">{{ mentoria.desempleado_nombre }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Detalles de la Mentor√≠a</h4>
                                <div class="info-item">
                                    <span class="info-label">√Årea de inter√©s:</span>
                                    <span class="info-value">{{ mentoria.area_interes }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Disponibilidad:</span>
                                    <span class="info-value">{{ mentoria.disponibilidad }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Iniciada el:</span>
                                    <span class="info-value">{{ mentoria.fecha_solicitud.strftime('%d/%m/%Y') }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Objetivos del Aprendiz</h4>
                                <p class="especificaciones">{{ mentoria.objetivo }}</p>
                            </div>
                        </div>

                        <!-- Botones de acci√≥n para mentor√≠as -->
                        <div class="trabajo-actions">
                            <button class="btn btn-complete" onclick="finalizarMentoriaTrabajador('{{ mentoria.id }}')">
                                <i class="fas fa-graduation-cap"></i> Mentor√≠a Completa
                            </button>
                            <button class="btn btn-contact" onclick="contactarAprendiz('{{ mentoria.desempleado_id }}')">
                                <i class="fas fa-comments"></i> Contactar Aprendiz
                            </button>
                            <button class="btn btn-cancel-job" onclick="abrirModalCancelacionMentoria('{{ mentoria.id }}')">
                                <i class="fas fa-times-circle"></i> Cancelar Mentor√≠a
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-users"></i>
                    <h3>No tienes mentor√≠as activas</h3>
                    <p>Cuando aceptes solicitudes de mentor√≠a, aparecer√°n aqu√≠.</p>
                </div>
                {% endif %}
            </div>

                        <!-- SECCI√ìN TRABAJOS COMPLETADOS A CLIENTES -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Trabajos Realizados a Clientes</h2>
                    <span class="contador-badge">{{ trabajos_completados|length }} finalizados</span>
                </div>
                
                {% if trabajos_completados %}
                <div class="trabajos-grid">
                    {% for trabajo in trabajos_completados %}
                    <div class="trabajo-card" data-tipo="completado">
                        <div class="tipo-badge tipo-contratacion">‚úÖ Completado</div>
                        
                        <div class="trabajo-header">
                            <h3>{{ trabajo.especializacion }}</h3>
                            <span class="estado-badge estado-completado">Finalizado</span>
                        </div>

                        <div class="trabajo-info">
                            <div class="info-group">
                                <h4>Informaci√≥n del Cliente</h4>
                                <div class="info-item">
                                    <span class="info-label">Cliente:</span>
                                    <span class="info-value">{{ trabajo.cliente_nombre }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Detalles del Trabajo</h4>
                                <div class="info-item">
                                    <span class="info-label">Fecha acordada:</span>
                                    <span class="info-value">{{ trabajo.fecha_trabajo_propuesta }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Fecha finalizaci√≥n:</span>
                                    <span class="info-value">{{ trabajo.fecha_finalizacion.strftime('%d/%m/%Y') if trabajo.fecha_finalizacion else 'No especificada' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ubicaci√≥n:</span>
                                    <span class="info-value">{{ trabajo.ubicacion }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Especificaciones del Trabajo</h4>
                                <p class="especificaciones">{{ trabajo.especificaciones }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-clipboard-check"></i>
                    <h3>No tienes trabajos completados</h3>
                    <p>Cuando finalices trabajos con clientes, aparecer√°n aqu√≠.</p>
                </div>
                {% endif %}
            </div>

            <!-- SECCI√ìN MENTOR√çAS COMPLETADAS -->
            <div class="seccion-trabajos">
                <div class="seccion-header">
                    <h2>Mentor√≠as Realizadas</h2>
                    <span class="contador-badge">{{ mentorias_completadas|length }} finalizadas</span>
                </div>
                
                {% if mentorias_completadas %}
                <div class="trabajos-grid">
                    {% for mentoria in mentorias_completadas %}
                    <div class="trabajo-card" data-tipo="mentoria-completada">
                        <div class="tipo-badge tipo-mentoria">üéì Mentor√≠a Completada</div>
                        
                        <div class="trabajo-header">
                            <h3>Mentor√≠a - {{ mentoria.area_interes }}</h3>
                            <span class="estado-badge estado-completado">Completada</span>
                        </div>

                        <div class="trabajo-info">
                            <div class="info-group">
                                <h4>Informaci√≥n del Aprendiz</h4>
                                <div class="info-item">
                                    <span class="info-label">Aprendiz:</span>
                                    <span class="info-value">{{ mentoria.desempleado_nombre }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Detalles de la Mentor√≠a</h4>
                                <div class="info-item">
                                    <span class="info-label">√Årea:</span>
                                    <span class="info-value">{{ mentoria.area_interes }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Iniciada:</span>
                                    <span class="info-value">{{ mentoria.fecha_solicitud.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Completada:</span>
                                    <span class="info-value">{{ mentoria.fecha_actualizacion.strftime('%d/%m/%Y') if mentoria.fecha_actualizacion else mentoria.fecha_completacion.strftime('%d/%m/%Y') if mentoria.fecha_completacion else 'No especificada' }}</span>
                                </div>
                            </div>

                            <div class="info-group">
                                <h4>Objetivos Cumplidos</h4>
                                <p class="especificaciones">{{ mentoria.objetivo }}</p>
                            </div>

                            {% if mentoria.calificacion %}
                            <div class="info-group">
                                <h4>Calificaci√≥n del Aprendiz</h4>
                                <div class="calificacion">
                                    {% for i in range(5) %}
                                        {% if i < mentoria.calificacion %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                    <span class="calificacion-text">({{ mentoria.calificacion }}/5)</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-section">
                    <i class="fas fa-user-graduate"></i>
                    <h3>No tienes mentor√≠as completadas</h3>
                    <p>Cuando completes mentor√≠as, aparecer√°n aqu√≠ con los logros.</p>
                </div>
                {% endif %}
            </div>

            
        </main>
    </div>

    <script>

        function finalizarMentoriaTrabajador(mentoriaId) {
    if (confirm('¬øEst√°s seguro de que deseas marcar esta mentor√≠a como completada?\n\nEl aprendiz recibir√° una notificaci√≥n.')) {
        fetch(`/finalizar_mentoria/${mentoriaId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Mentor√≠a marcada como completada. El aprendiz puede verla en sus capacitaciones completadas.');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}
        function finalizarTrabajo(trabajoId) {
            if (confirm('¬øEst√°s seguro de que deseas marcar este trabajo como finalizado?')) {
                fetch(`/finalizar_trabajo/${trabajoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Trabajo marcado como finalizado con √©xito');
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la solicitud');
                });
            }
        }

        function contactarCliente(clienteId) {
            alert('Funcionalidad de contacto con el cliente en desarrollo para ID: ' + clienteId);
        }

        // Modal cancelaci√≥n
        let trabajoCancelacionId = '';

        function abrirModalCancelacion(trabajoId) {
            trabajoCancelacionId = trabajoId;
            document.getElementById('trabajoIdCancelacion').value = trabajoId;
            document.getElementById('motivoCancelacion').value = '';
            document.getElementById('modalCancelacion').style.display = 'flex';
        }

        function cerrarModalCancelacion() {
            document.getElementById('modalCancelacion').style.display = 'none';
            trabajoCancelacionId = '';
        }

        function confirmarCancelacion() {
            const motivo = document.getElementById('motivoCancelacion').value.trim();
            if (!motivo) { alert('Por favor, ingresa el motivo de la cancelaci√≥n.'); return; }
            if (confirm('¬øEst√°s seguro de cancelar este trabajo?')) {
                fetch(`/cancelar_trabajo/${trabajoCancelacionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ motivo: motivo })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Trabajo cancelado correctamente');
                        cerrarModalCancelacion();
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al procesar la solicitud');
                });
            }
        }

        // Cerrar modal al hacer click fuera del contenido
        document.getElementById('modalCancelacion').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalCancelacion();
        });

        // Evitar submit con Enter dentro del textarea
        document.getElementById('formCancelacion').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') e.preventDefault();
        });
    </script>
</body>
</html>
